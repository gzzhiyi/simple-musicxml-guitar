import{isEmpty,find,isArray,isObject,filter,uniqBy,last,has}from"lodash";var validator$2={},util$2={};!function(e){var t=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",t="["+t+"][:A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*";const r=new RegExp("^"+t+"$");e.isExist=function(t){return void 0!==t},e.isEmptyObject=function(t){return 0===Object.keys(t).length},e.merge=function(e,r,i){if(r){var n=Object.keys(r),s=n.length;for(let t=0;t<s;t++)e[n[t]]="strict"===i?[r[n[t]]]:r[n[t]]}},e.getValue=function(t){return e.isExist(t)?t:""},e.isName=function(t){t=r.exec(t);return!(null==t)},e.getAllMatches=function(t,e){const r=[];let i=e.exec(t);for(;i;){const s=[];s.startIndex=e.lastIndex-i[0].length;var n=i.length;for(let t=0;t<n;t++)s.push(i[t]);r.push(s),i=e.exec(t)}return r},e.nameRegexp=t}(util$2);const util$1=util$2,defaultOptions$2={allowBooleanAttributes:!1,unpairedTags:[]};function isWhiteSpace(t){return" "===t||"\t"===t||"\n"===t||"\r"===t}function readPI(t,e){for(var r=e;e<t.length;e++)if("?"==t[e]||" "==t[e]){var i=t.substr(r,e-r);if(5<e&&"xml"===i)return getErrorObject("InvalidXml","XML declaration allowed only at the start of the document.",getLineNumberForPosition(t,e));if("?"==t[e]&&">"==t[e+1]){e++;break}}return e}function readCommentAndCDATA(e,r){if(e.length>r+5&&"-"===e[r+1]&&"-"===e[r+2]){for(r+=3;r<e.length;r++)if("-"===e[r]&&"-"===e[r+1]&&">"===e[r+2]){r+=2;break}}else if(e.length>r+8&&"D"===e[r+1]&&"O"===e[r+2]&&"C"===e[r+3]&&"T"===e[r+4]&&"Y"===e[r+5]&&"P"===e[r+6]&&"E"===e[r+7]){let t=1;for(r+=8;r<e.length;r++)if("<"===e[r])t++;else if(">"===e[r]&&0===--t)break}else if(e.length>r+9&&"["===e[r+1]&&"C"===e[r+2]&&"D"===e[r+3]&&"A"===e[r+4]&&"T"===e[r+5]&&"A"===e[r+6]&&"["===e[r+7])for(r+=8;r<e.length;r++)if("]"===e[r]&&"]"===e[r+1]&&">"===e[r+2]){r+=2;break}return r}validator$2.validate=function(n,s){s=Object.assign({},defaultOptions$2,s);const o=[];let a=!1,l=!1;"\ufeff"===n[0]&&(n=n.substr(1));for(let i=0;i<n.length;i++)if("<"===n[i]&&"?"===n[i+1]){if((i=readPI(n,i+=2)).err)return i}else if("<"===n[i]){var u=i;if("!"===n[++i])i=readCommentAndCDATA(n,i);else{let t=!1,e=("/"===n[i]&&(t=!0,i++),"");for(;i<n.length&&">"!==n[i]&&" "!==n[i]&&"\t"!==n[i]&&"\n"!==n[i]&&"\r"!==n[i];i++)e+=n[i];if("/"===(e=e.trim())[e.length-1]&&(e=e.substring(0,e.length-1),i--),!validateTagName(e)){let t;return getErrorObject("InvalidTag",t=0===e.trim().length?"Invalid space after '<'.":"Tag '"+e+"' is an invalid name.",getLineNumberForPosition(n,i))}var d=readAttributeStr(n,i);if(!1===d)return getErrorObject("InvalidAttr","Attributes for '"+e+"' have open quote.",getLineNumberForPosition(n,i));let r=d.value;if(i=d.index,"/"===r[r.length-1]){var p=i-r.length,h=validateAttributeString(r=r.substring(0,r.length-1),s);if(!0!==h)return getErrorObject(h.err.code,h.err.msg,getLineNumberForPosition(n,p+h.err.line));a=!0}else if(t){if(!d.tagClosed)return getErrorObject("InvalidTag","Closing tag '"+e+"' doesn't have proper closing.",getLineNumberForPosition(n,i));if(0<r.trim().length)return getErrorObject("InvalidTag","Closing tag '"+e+"' can't have attributes or invalid starting.",getLineNumberForPosition(n,u));p=o.pop();if(e!==p.tagName)return h=getLineNumberForPosition(n,p.tagStartPos),getErrorObject("InvalidTag","Expected closing tag '"+p.tagName+"' (opened in line "+h.line+", col "+h.col+") instead of closing tag '"+e+"'.",getLineNumberForPosition(n,u));0==o.length&&(l=!0)}else{d=validateAttributeString(r,s);if(!0!==d)return getErrorObject(d.err.code,d.err.msg,getLineNumberForPosition(n,i-r.length+d.err.line));if(!0===l)return getErrorObject("InvalidXml","Multiple possible root nodes found.",getLineNumberForPosition(n,i));-1===s.unpairedTags.indexOf(e)&&o.push({tagName:e,tagStartPos:u}),a=!0}for(i++;i<n.length;i++)if("<"===n[i])if("!"===n[i+1])i=readCommentAndCDATA(n,++i);else{if("?"!==n[i+1])break;if((i=readPI(n,++i)).err)return i}else if("&"===n[i]){var g=validateAmpersand(n,i);if(-1==g)return getErrorObject("InvalidChar","char '&' is not expected.",getLineNumberForPosition(n,i));i=g}else if(!0===l&&!isWhiteSpace(n[i]))return getErrorObject("InvalidXml","Extra text at the end",getLineNumberForPosition(n,i));"<"===n[i]&&i--}}else if(!isWhiteSpace(n[i]))return getErrorObject("InvalidChar","char '"+n[i]+"' is not expected.",getLineNumberForPosition(n,i));return a?1==o.length?getErrorObject("InvalidTag","Unclosed tag '"+o[0].tagName+"'.",getLineNumberForPosition(n,o[0].tagStartPos)):!(0<o.length)||getErrorObject("InvalidXml","Invalid '"+JSON.stringify(o.map(t=>t.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):getErrorObject("InvalidXml","Start tag expected.",1)};const doubleQuote='"',singleQuote="'";function readAttributeStr(t,e){let r="",i="",n=!1;for(;e<t.length;e++){if(t[e]===doubleQuote||t[e]===singleQuote)""===i?i=t[e]:i===t[e]&&(i="");else if(">"===t[e]&&""===i){n=!0;break}r+=t[e]}return""===i&&{value:r,index:e,tagClosed:n}}const validAttrStrRegxp=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function validateAttributeString(t,e){var r=util$1.getAllMatches(t,validAttrStrRegxp);const i={};for(let t=0;t<r.length;t++){if(0===r[t][1].length)return getErrorObject("InvalidAttr","Attribute '"+r[t][2]+"' has no space in starting.",getPositionFromMatch(r[t]));if(void 0!==r[t][3]&&void 0===r[t][4])return getErrorObject("InvalidAttr","Attribute '"+r[t][2]+"' is without value.",getPositionFromMatch(r[t]));if(void 0===r[t][3]&&!e.allowBooleanAttributes)return getErrorObject("InvalidAttr","boolean attribute '"+r[t][2]+"' is not allowed.",getPositionFromMatch(r[t]));var n=r[t][2];if(!validateAttrName(n))return getErrorObject("InvalidAttr","Attribute '"+n+"' is an invalid name.",getPositionFromMatch(r[t]));if(i.hasOwnProperty(n))return getErrorObject("InvalidAttr","Attribute '"+n+"' is repeated.",getPositionFromMatch(r[t]));i[n]=1}return!0}function validateNumberAmpersand(t,e){let r=/\d/;for("x"===t[e]&&(e++,r=/[\da-fA-F]/);e<t.length;e++){if(";"===t[e])return e;if(!t[e].match(r))break}return-1}function validateAmpersand(t,e){if(";"===t[++e])return-1;if("#"===t[e])return validateNumberAmpersand(t,++e);let r=0;for(;e<t.length;e++,r++)if(!(t[e].match(/\w/)&&r<20)){if(";"===t[e])break;return-1}return e}function getErrorObject(t,e,r){return{err:{code:t,msg:e,line:r.line||r,col:r.col}}}function validateAttrName(t){return util$1.isName(t)}function validateTagName(t){return util$1.isName(t)}function getLineNumberForPosition(t,e){t=t.substring(0,e).split(/\r?\n/);return{line:t.length,col:t[t.length-1].length+1}}function getPositionFromMatch(t){return t.startIndex+t[1].length}var OptionsBuilder={};const defaultOptions$1={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0},tagValueProcessor:function(t,e){return e},attributeValueProcessor:function(t,e){return e},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1},buildOptions$1=function(t){return Object.assign({},defaultOptions$1,t)};OptionsBuilder.buildOptions=buildOptions$1,OptionsBuilder.defaultOptions=defaultOptions$1;class XmlNode{constructor(t){this.tagname=t,this.child=[],this[":@"]={}}add(t,e){this.child.push({[t]:e})}addChild(t){t[":@"]&&0<Object.keys(t[":@"]).length?this.child.push({[t.tagname]:t.child,":@":t[":@"]}):this.child.push({[t.tagname]:t.child})}}var xmlNode$1=XmlNode;function readDocType$1(s,o){var a={};if("O"!==s[o+3]||"C"!==s[o+4]||"T"!==s[o+5]||"Y"!==s[o+6]||"P"!==s[o+7]||"E"!==s[o+8])throw new Error("Invalid Tag instead of DOCTYPE");{o+=9;let t=1,e=!1,r=!1,i=!1,n="";for(;o<s.length;o++)if("<"===s[o]){if(e&&"!"===s[o+1]&&"E"===s[o+2]&&"N"===s[o+3]&&"T"===s[o+4]&&"I"===s[o+5]&&"T"===s[o+6]&&"Y"===s[o+7])o+=7,r=!0;else if(e&&"!"===s[o+1]&&"E"===s[o+2]&&"L"===s[o+3]&&"E"===s[o+4]&&"M"===s[o+5]&&"E"===s[o+6]&&"N"===s[o+7]&&"T"===s[o+8])o+=8;else if(e&&"!"===s[o+1]&&"A"===s[o+2]&&"T"===s[o+3]&&"T"===s[o+4]&&"L"===s[o+5]&&"I"===s[o+6]&&"S"===s[o+7]&&"T"===s[o+8])o+=8;else if(e&&"!"===s[o+1]&&"N"===s[o+2]&&"O"===s[o+3]&&"T"===s[o+4]&&"A"===s[o+5]&&"T"===s[o+6]&&"I"===s[o+7]&&"O"===s[o+8]&&"N"===s[o+9])o+=9;else{if("!"!==s[o+1]||"-"!==s[o+2]||"-"!==s[o+3])throw new Error("Invalid DOCTYPE");i=!0}t++,n=""}else if(">"===s[o]){if(i){if("-"!==s[o-1]||"-"!==s[o-2])throw new Error("Invalid XML comment in DOCTYPE");i=!1}else r&&(parseEntityExp(n,a),r=!1);if(0===--t)break}else"["===s[o]?e=!0:n+=s[o];if(0!==t)throw new Error("Unclosed DOCTYPE")}return{entities:a,i:o}}const entityRegex=RegExp("^\\s([a-zA-z0-0]+)[ \t](['\"])([^&]+)\\2");function parseEntityExp(t,e){t=entityRegex.exec(t);t&&(e[t[1]]={regx:RegExp(`&${t[1]};`,"g"),val:t[3]})}var DocTypeReader=readDocType$1;const hexRegex=/^[-+]?0x[a-fA-F0-9]+$/,numRegex=/^([\-\+])?(0*)(\.[0-9]+([eE]\-?[0-9]+)?|[0-9]+(\.[0-9]+([eE]\-?[0-9]+)?)?)$/,consider=(!Number.parseInt&&window.parseInt&&(Number.parseInt=window.parseInt),!Number.parseFloat&&window.parseFloat&&(Number.parseFloat=window.parseFloat),{hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0});function toNumber$1(e,r={}){if(r=Object.assign({},consider,r),e&&"string"==typeof e){let t=e.trim();if(void 0===r.skipLike||!r.skipLike.test(t)){if(r.hex&&hexRegex.test(t))return Number.parseInt(t,16);var i=numRegex.exec(t);if(i){var n=i[1],s=i[2],o=trimZeros(i[3]),i=i[4]||i[6];if(!r.leadingZeros&&0<s.length&&n&&"."!==t[2])return e;if(!r.leadingZeros&&0<s.length&&!n&&"."!==t[1])return e;{var a=Number(t);const l=""+a;return-1!==l.search(/[eE]/)?r.eNotation?a:e:i?r.eNotation?a:e:-1!==t.indexOf(".")?"0"===l&&""===o||l===o||n&&l==="-"+o?a:e:s?o===l||n+o===l?a:e:t===l||t===n+l?a:e}}}}return e}function trimZeros(t){return t&&-1!==t.indexOf(".")&&("."===(t=t.replace(/0+$/,""))?t="0":"."===t[0]?t="0"+t:"."===t[t.length-1]&&(t=t.substr(0,t.length-1))),t}var strnum=toNumber$1;const util=util$2,xmlNode=xmlNode$1,readDocType=DocTypeReader,toNumber=toNumber$1;"<((!\\[CDATA\\[([\\s\\S]*?)(]]>))|((NAME:)?(NAME))([^>]*)>|((\\/)(NAME)\\s*>))([^<]*)".replace(/NAME/g,util.nameRegexp);class OrderedObjParser$1{constructor(t){this.options=t,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={amp:{regex:/&(amp|#38|#x26);/g,val:"&"},apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"}},this.addExternalEntities=addExternalEntities,this.parseXml=parseXml,this.parseTextData=parseTextData,this.resolveNameSpace=resolveNameSpace,this.buildAttributesMap=buildAttributesMap,this.isItStopNode=isItStopNode,this.replaceEntitiesValue=replaceEntitiesValue$2,this.readStopNodeData=readStopNodeData,this.saveTextToParentTag=saveTextToParentTag}}function addExternalEntities(e){var r=Object.keys(e);for(let t=0;t<r.length;t++){var i=r[t];this.lastEntities[i]={regex:new RegExp("&"+i+";","g"),val:e[i]}}}function parseTextData(t,e,r,i,n,s,o){if(void 0!==t&&0<(t=this.options.trimValues&&!i?t.trim():t).length)return o||(t=this.replaceEntitiesValue(t)),null==(i=this.options.tagValueProcessor(e,t,r,n,s))?t:typeof i!=typeof t||i!==t?i:this.options.trimValues||t.trim()===t?parseValue(t,this.options.parseTagValue,this.options.numberParseOptions):t}function resolveNameSpace(t){if(this.options.removeNSPrefix){var e=t.split(":"),r="/"===t.charAt(0)?"/":"";if("xmlns"===e[0])return"";2===e.length&&(t=r+e[1])}return t}const attrsRegx=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function buildAttributesMap(t,r){if(!this.options.ignoreAttributes&&"string"==typeof t){var i=util.getAllMatches(t,attrsRegx),n=i.length;const a={};for(let e=0;e<n;e++){var s=this.resolveNameSpace(i[e][1]);let t=i[e][4];var o=this.options.attributeNamePrefix+s;s.length&&(void 0!==t?(this.options.trimValues&&(t=t.trim()),t=this.replaceEntitiesValue(t),null==(s=this.options.attributeValueProcessor(s,t,r))?a[o]=t:typeof s!=typeof t||s!==t?a[o]=s:a[o]=parseValue(t,this.options.parseAttributeValue,this.options.numberParseOptions)):this.options.allowBooleanAttributes&&(a[o]=!0))}if(Object.keys(a).length){if(this.options.attributesGroupName){const e={};return e[this.options.attributesGroupName]=a,e}return a}}}const parseXml=function(n){n=n.replace(/\r\n?/g,"\n");var t=new xmlNode("!xml");let s=t,o="",a="";for(let i=0;i<n.length;i++)if("<"===n[i])if("/"===n[i+1]){var e=findClosingIndex(n,">",i,"Closing Tag is not closed.");let t=n.substring(i+2,e).trim();!this.options.removeNSPrefix||-1!==(r=t.indexOf(":"))&&(t=t.substr(r+1)),this.options.transformTagName&&(t=this.options.transformTagName(t)),s&&(o=this.saveTextToParentTag(o,s,a)),a=a.substr(0,a.lastIndexOf(".")),s=this.tagsNodeStack.pop(),o="",i=e}else if("?"===n[i+1]){var r=readTagExp(n,i,!1,"?>");if(!r)throw new Error("Pi Tag is not closed.");if(o=this.saveTextToParentTag(o,s,a),!(this.options.ignoreDeclaration&&"?xml"===r.tagName||this.options.ignorePiTags)){const g=new xmlNode(r.tagName);g.add(this.options.textNodeName,""),r.tagName!==r.tagExp&&r.attrExpPresent&&(g[":@"]=this.buildAttributesMap(r.tagExp,a)),s.addChild(g)}i=r.closeIndex+1}else if("!--"===n.substr(i+1,3)){e=findClosingIndex(n,"--\x3e",i+4,"Comment is not closed.");this.options.commentPropName&&(l=n.substring(i+4,e-2),o=this.saveTextToParentTag(o,s,a),s.add(this.options.commentPropName,[{[this.options.textNodeName]:l}])),i=e}else if("!D"===n.substr(i+1,2)){var l=readDocType(n,i);this.docTypeEntities=l.entities,i=l.i}else if("!["===n.substr(i+1,2)){var u=findClosingIndex(n,"]]>",i,"CDATA is not closed.")-2,d=n.substring(i+9,u);if(o=this.saveTextToParentTag(o,s,a),this.options.cdataPropName)s.add(this.options.cdataPropName,[{[this.options.textNodeName]:d}]);else{let t=this.parseTextData(d,s.tagname,a,!0,!1,!0);null==t&&(t=""),s.add(this.options.textNodeName,t)}i=2+u}else{d=readTagExp(n,i,this.options.removeNSPrefix);let e=d.tagName,r=d.tagExp;var u=d.attrExpPresent,p=d.closeIndex,h=(this.options.transformTagName&&(e=this.options.transformTagName(e)),s&&o&&"!xml"!==s.tagname&&(o=this.saveTextToParentTag(o,s,a,!1)),e!==t.tagname&&(a+=a?"."+e:e),s);if(h&&-1!==this.options.unpairedTags.indexOf(h.tagname)&&(s=this.tagsNodeStack.pop()),this.isItStopNode(this.options.stopNodes,a,e)){let t="";if(0<r.length&&r.lastIndexOf("/")===r.length-1)i=d.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(e))i=d.closeIndex;else{h=this.readStopNodeData(n,e,p+1);if(!h)throw new Error("Unexpected end of "+e);i=h.i,t=h.tagContent}const c=new xmlNode(e);e!==r&&u&&(c[":@"]=this.buildAttributesMap(r,a)),t=t&&this.parseTextData(t,e,a,!0,u,!0,!0),a=a.substr(0,a.lastIndexOf(".")),c.add(this.options.textNodeName,t),s.addChild(c)}else{if(0<r.length&&r.lastIndexOf("/")===r.length-1){r="/"===e[e.length-1]?e=e.substr(0,e.length-1):r.substr(0,r.length-1),this.options.transformTagName&&(e=this.options.transformTagName(e));const f=new xmlNode(e);e!==r&&u&&(f[":@"]=this.buildAttributesMap(r,a)),a=a.substr(0,a.lastIndexOf(".")),s.addChild(f)}else{const m=new xmlNode(e);this.tagsNodeStack.push(s),e!==r&&u&&(m[":@"]=this.buildAttributesMap(r,a)),s.addChild(m),s=m}o="",i=p}}else o+=n[i];return t.child},replaceEntitiesValue$2=function(t){if(this.options.processEntities){for(var e in this.docTypeEntities){e=this.docTypeEntities[e];t=t.replace(e.regx,e.val)}for(var r in this.lastEntities){r=this.lastEntities[r];t=t.replace(r.regex,r.val)}if(this.options.htmlEntities)for(var i in this.htmlEntities){i=this.htmlEntities[i];t=t.replace(i.regex,i.val)}}return t};function saveTextToParentTag(t,e,r,i){return t&&(void 0===i&&(i=0===Object.keys(e.child).length),void 0!==(t=this.parseTextData(t,e.tagname,r,!1,!!e[":@"]&&0!==Object.keys(e[":@"]).length,i))&&""!==t&&e.add(this.options.textNodeName,t),t=""),t}function isItStopNode(t,e,r){var i="*."+r;for(const s in t){var n=t[s];if(i===n||e===n)return!0}return!1}function tagExpWithClosingIndex(r,t,i=">"){let n,s="";for(let e=t;e<r.length;e++){let t=r[e];if(n)t===n&&(n="");else if('"'===t||"'"===t)n=t;else if(t===i[0]){if(!i[1])return{data:s,index:e};if(r[e+1]===i[1])return{data:s,index:e}}else"\t"===t&&(t=" ");s+=t}}function findClosingIndex(t,e,r,i){t=t.indexOf(e,r);if(-1===t)throw new Error(i);return t+e.length-1}function readTagExp(i,n,s,o=">"){const a=tagExpWithClosingIndex(i,n+1,o);if(a){let t=a.data;i=a.index,n=t.search(/\s/);let e=t,r=!0;return-1!==n&&(e=t.substr(0,n).replace(/\s\s*$/,""),t=t.substr(n+1)),s&&-1!==(o=e.indexOf(":"))&&(e=e.substr(o+1),r=e!==a.data.substr(o+1)),{tagName:e,tagExp:t,closeIndex:i,attrExpPresent:r}}}function readStopNodeData(t,e,r){var i=r;let n=1;for(;r<t.length;r++)if("<"===t[r])if("/"===t[r+1]){var s=findClosingIndex(t,">",r,e+" is not closed"),o=t.substring(r+2,s).trim();if(o===e&&0===--n)return{tagContent:t.substring(i,r),i:s};r=s}else"?"===t[r+1]?r=findClosingIndex(t,"?>",r+1,"StopNode is not closed."):"!--"===t.substr(r+1,3)?r=findClosingIndex(t,"--\x3e",r+3,"StopNode is not closed."):"!["===t.substr(r+1,2)?r=findClosingIndex(t,"]]>",r,"StopNode is not closed.")-2:(o=readTagExp(t,r,">"))&&((o&&o.tagName)===e&&"/"!==o.tagExp[o.tagExp.length-1]&&n++,r=o.closeIndex)}function parseValue(t,e,r){return e&&"string"==typeof t?"true"===(e=t.trim())||"false"!==e&&toNumber(t,r):util.isExist(t)?t:""}var OrderedObjParser_1=OrderedObjParser$1,node2json={};function prettify$1(t,e){return compress(t,e)}function compress(r,i,n){let s;const o={};for(let t=0;t<r.length;t++){var a=r[t],l=propName$1(a);let e="";if(e=void 0===n?l:n+"."+l,l===i.textNodeName)void 0===s?s=a[l]:s+=""+a[l];else if(void 0!==l&&a[l]){let t=compress(a[l],i,e);var u=isLeafTag(t,i);a[":@"]?assignAttributes(t,a[":@"],e,i):1!==Object.keys(t).length||void 0===t[i.textNodeName]||i.alwaysCreateTextNode?0===Object.keys(t).length&&(i.alwaysCreateTextNode?t[i.textNodeName]="":t=""):t=t[i.textNodeName],void 0!==o[l]&&o.hasOwnProperty(l)?(Array.isArray(o[l])||(o[l]=[o[l]]),o[l].push(t)):i.isArray(l,e,u)?o[l]=[t]:o[l]=t}}return"string"==typeof s?0<s.length&&(o[i.textNodeName]=s):void 0!==s&&(o[i.textNodeName]=s),o}function propName$1(t){var e=Object.keys(t);for(let t=0;t<e.length;t++){var r=e[t];if(":@"!==r)return r}}function assignAttributes(e,r,i,n){if(r){var s=Object.keys(r),o=s.length;for(let t=0;t<o;t++){var a=s[t];n.isArray(a,i+"."+a,!0,!0)?e[a]=[r[a]]:e[a]=r[a]}}}function isLeafTag(t,e){var r=Object.keys(t).length;return!!(0===r||1===r&&t[e.textNodeName])}node2json.prettify=prettify$1;const buildOptions=OptionsBuilder["buildOptions"],OrderedObjParser=OrderedObjParser_1,prettify=node2json["prettify"],validator$1=validator$2;class XMLParser$1{constructor(t){this.externalEntities={},this.options=buildOptions(t)}parse(t,e){if("string"!=typeof t){if(!t.toString)throw new Error("XML data is accepted in String or Bytes[] form.");t=t.toString()}if(e){!0===e&&(e={});e=validator$1.validate(t,e);if(!0!==e)throw Error(`${e.err.msg}:${e.err.line}:`+e.err.col)}const r=new OrderedObjParser(this.options);r.addExternalEntities(this.externalEntities);e=r.parseXml(t);return this.options.preserveOrder||void 0===e?e:prettify(e,this.options)}addEntity(t,e){if(-1!==e.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==t.indexOf("&")||-1!==t.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");this.externalEntities[t]=e}}var XMLParser_1=XMLParser$1;const EOL="\n";function toXml(t,e){return arrToStr(t,e,"",0)}function arrToStr(r,i,n,s){let o="",a="";i.format&&0<i.indentBy.length&&(a=EOL+""+i.indentBy.repeat(s));for(let t=0;t<r.length;t++){var l=r[t],u=propName(l);let e="";if(e=0===n.length?u:n+"."+u,u===i.textNodeName){let t=l[u];isStopNode(e,i)||(t=replaceEntitiesValue$1(t=i.tagValueProcessor(u,t),i)),o+=a+t}else if(u===i.cdataPropName)o+=a+`<![CDATA[${l[u][0][i.textNodeName]}]]>`;else if(u===i.commentPropName)o+=a+`<!--${l[u][0][i.textNodeName]}-->`;else if("?"===u[0]){var d=attr_to_str(l[":@"],i),p="?xml"===u?"":a;let t=l[u][0][i.textNodeName];t=0!==t.length?" "+t:"",o+=p+`<${u}${t}${d}?>`}else{p=attr_to_str(l[":@"],i),d=a+"<"+u+p,l=arrToStr(l[u],i,e,s+1);-1!==i.unpairedTags.indexOf(u)?i.suppressUnpairedNode?o+=d+">":o+=d+"/>":l&&0!==l.length||!i.suppressEmptyNode?o+=d+`>${l}${a}</${u}>`:o+=d+"/>"}}return o}function propName(t){var e=Object.keys(t);for(let t=0;t<e.length;t++){var r=e[t];if(":@"!==r)return r}}function attr_to_str(t,e){let r="";if(t&&!e.ignoreAttributes)for(var i in t){var n;!0===(n=replaceEntitiesValue$1(e.attributeValueProcessor(i,t[i]),e))&&e.suppressBooleanAttributes?r+=" "+i.substr(e.attributeNamePrefix.length):r+=` ${i.substr(e.attributeNamePrefix.length)}="${n}"`}return r}function isStopNode(t,e){var r,i=(t=t.substr(0,t.length-e.textNodeName.length-1)).substr(t.lastIndexOf(".")+1);for(r in e.stopNodes)if(e.stopNodes[r]===t||e.stopNodes[r]==="*."+i)return!0;return!1}function replaceEntitiesValue$1(e,r){if(e&&0<e.length&&r.processEntities)for(let t=0;t<r.entities.length;t++){var i=r.entities[t];e=e.replace(i.regex,i.val)}return e}var orderedJs2Xml=toXml;const buildFromOrderedJs=toXml,defaultOptions={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(t,e){return e},attributeValueProcessor:function(t,e){return e},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],transformTagName:!1};function Builder(t){this.options=Object.assign({},defaultOptions,t),this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=isAttribute),this.processTextOrObjNode=processTextOrObjNode,this.options.format?(this.indentate=indentate,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine=""),this.options.suppressEmptyNode?(this.buildTextNode=buildEmptyTextNode,this.buildObjNode=buildEmptyObjNode):(this.buildTextNode=buildTextValNode,this.buildObjNode=buildObjectNode),this.buildTextValNode=buildTextValNode,this.buildObjectNode=buildObjectNode,this.replaceEntitiesValue=replaceEntitiesValue,this.buildAttrPairStr=buildAttrPairStr}function buildAttrPairStr(t,e){return e=this.options.attributeValueProcessor(t,""+e),e=this.replaceEntitiesValue(e),this.options.suppressBooleanAttributes&&"true"===e?" "+t:" "+t+'="'+e+'"'}function processTextOrObjNode(t,e,r){var i=this.j2x(t,r+1);return void 0!==t[this.options.textNodeName]&&1===Object.keys(t).length?this.buildTextNode(t[this.options.textNodeName],e,i.attrStr,r):this.buildObjNode(i.val,e,i.attrStr,r)}function buildObjectNode(t,e,r,i){let n="</"+e+this.tagEndChar,s="";return"?"===e[0]&&(s="?",n=""),r&&-1===t.indexOf("<")?this.indentate(i)+"<"+e+r+s+">"+t+n:!1!==this.options.commentPropName&&e===this.options.commentPropName&&0===s.length?this.indentate(i)+`<!--${t}-->`+this.newLine:this.indentate(i)+"<"+e+r+s+this.tagEndChar+t+this.indentate(i)+n}function buildEmptyObjNode(t,e,r,i){return""!==t?this.buildObjectNode(t,e,r,i):"?"===e[0]?this.indentate(i)+"<"+e+r+"?"+this.tagEndChar:this.indentate(i)+"<"+e+r+"/"+this.tagEndChar}function buildTextValNode(t,e,r,i){return!1!==this.options.cdataPropName&&e===this.options.cdataPropName?this.indentate(i)+`<![CDATA[${t}]]>`+this.newLine:!1!==this.options.commentPropName&&e===this.options.commentPropName?this.indentate(i)+`<!--${t}-->`+this.newLine:(t=this.options.tagValueProcessor(e,t),""===(t=this.replaceEntitiesValue(t))&&-1!==this.options.unpairedTags.indexOf(e)?this.options.suppressUnpairedNode?this.indentate(i)+"<"+e+this.tagEndChar:this.indentate(i)+"<"+e+"/"+this.tagEndChar:this.indentate(i)+"<"+e+r+">"+t+"</"+e+this.tagEndChar)}function replaceEntitiesValue(e){if(e&&0<e.length&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){var r=this.options.entities[t];e=e.replace(r.regex,r.val)}return e}function buildEmptyTextNode(t,e,r,i){return""===t&&-1!==this.options.unpairedTags.indexOf(e)?this.options.suppressUnpairedNode?this.indentate(i)+"<"+e+this.tagEndChar:this.indentate(i)+"<"+e+"/"+this.tagEndChar:""!==t?this.buildTextValNode(t,e,r,i):"?"===e[0]?this.indentate(i)+"<"+e+r+"?"+this.tagEndChar:this.indentate(i)+"<"+e+r+"/"+this.tagEndChar}function indentate(t){return this.options.indentBy.repeat(t)}function isAttribute(t){return!!t.startsWith(this.options.attributeNamePrefix)&&t.substr(this.attrPrefixLen)}Builder.prototype.build=function(t){return this.options.preserveOrder?buildFromOrderedJs(t,this.options):(Array.isArray(t)&&this.options.arrayNodeName&&1<this.options.arrayNodeName.length&&(t={[this.options.arrayNodeName]:t}),this.j2x(t,0).val)},Builder.prototype.j2x=function(e,r){let i="",n="";for(var s in e)if(void 0!==e[s])if(null===e[s])"?"===s[0]?n+=this.indentate(r)+"<"+s+"?"+this.tagEndChar:n+=this.indentate(r)+"<"+s+"/"+this.tagEndChar;else if(e[s]instanceof Date)n+=this.buildTextNode(e[s],s,"",r);else if("object"!=typeof e[s]){var t=this.isAttribute(s);t?i+=this.buildAttrPairStr(t,""+e[s]):s===this.options.textNodeName?(t=this.options.tagValueProcessor(s,""+e[s]),n+=this.replaceEntitiesValue(t)):n+=this.buildTextNode(e[s],s,"",r)}else if(Array.isArray(e[s])){var o=e[s].length;for(let t=0;t<o;t++){var a=e[s][t];void 0!==a&&(null===a?"?"===s[0]?n+=this.indentate(r)+"<"+s+"?"+this.tagEndChar:n+=this.indentate(r)+"<"+s+"/"+this.tagEndChar:n+="object"==typeof a?this.processTextOrObjNode(a,s,r):this.buildTextNode(a,s,"",r))}}else if(this.options.attributesGroupName&&s===this.options.attributesGroupName){var l=Object.keys(e[s]),u=l.length;for(let t=0;t<u;t++)i+=this.buildAttrPairStr(l[t],""+e[s][l[t]])}else n+=this.processTextOrObjNode(e[s],s,r);return{attrStr:i,val:n}};var json2xml=Builder;const validator=validator$2,XMLParser=XMLParser_1,XMLBuilder=Builder;var fxp={XMLParser:XMLParser,XMLValidator:validator,XMLBuilder:XMLBuilder};function formatNoteData(t){const r=[];return t.map(t=>{var{string:t,fret:e}=t;r.push({string:t,fret:e})}),r}function findChordName(t=[],r=[]){return isEmpty(t)||isEmpty(r)||t.map(t=>{var e;"chord"===t.view&&(e=find(r,{data:formatNoteData(t.data)}),t.name=e?.name||"")}),t}function findAllParts(t){t=t["score-partwise"].part;return isArray(t)?t:isObject(t)?[t]:[]}function isTAB(t){const e=(t=isArray(t)?t[0]:t)?.attributes?.clef;let r=!1;return isArray(e)?e.map(t=>{"TAB"===t?.sign&&(r=!0)}):isObject(e)&&(t=e,r="TAB"===t.sign),r}function getMeasure(t,r){if(isArray(t)){const i=[];return t.map(t=>{var e={partId:r};isObject(t)?i.push({...e,...t}):i.push({o:e})}),i}return isObject(t)?[t]:[]}function findAllMeasures(t){let e=[];return t.map(t=>{isTAB(t.measure)&&(t=getMeasure(t.measure,t._id),e=e.concat(t))}),e}function findAllHarmonies(t){const r=[];return(t=filter(t,"harmony")).map(t=>{const e=t["harmony"];isArray(e)?e.map(t=>{r.push(t)}):r.push(e)}),r}function findAllNotes(t){let e=[];return t.map(t=>{isEmpty(t.note)||(e=e.concat(t.note))}),e}function getScoreType(t){return isEmpty(t["score-partwise"])?isEmpty(t["score-timewise"])?"unkonw":"timewise":"partwise"}function findTab(t){let i={};var e;return isArray(t)?t.map(t=>{var e,r;"TAB"===t?.sign&&({line:t,sign:e,_number:r}=t,i={line:t,sign:e,number:r})}):isObject(t)&&({line:t,sign:e}=t,i={line:t,sign:e}),i}function getClef(t,e="TAB"){let r={};return t.map(t=>{var t=t["attributes"];t&&(t=t["clef"],isEmpty(t)||"TAB"===e&&(r=findTab(t)))}),r}function getTuningStep(t){let n=[];return t.map(t=>{t=t.attributes;if(!isEmpty(t)){const r=t["staff-details"];if(!isEmpty(r)){let e=null;if(isArray(r)?r.map(t=>{t?.["staff-tuning"]&&(e=t)}):e=r,!isEmpty(e["staff-tuning"])){const i=[];e["staff-tuning"].map(t=>{i.push(t["tuning-step"])}),n=i}}}}),n}function formatNotes(t){if(isArray(t)){const e=[];return t.map((t={})=>{e.push({string:t.string-1,fret:t.fret,step:t.step||"",octave:t.octave||""})}),e}return isObject(t)?{string:t.string-1,fret:t.fret,step:t.step,octave:t.octave}:[]}function getName(t,e){return""+(t?.["root-step"]||"")+(1===t?.["root-alter"]?"#":"")+({major:"M",minor:"m",augmented:"aug",diminished:"dim",dominant:"7","suspended-second":"sus2","suspended-fourth":"sus4","major-sixth":"6","major-seventh":"maj7","major-ninth":"maj9","minor-sixth":"m6","minor-seventh":"m7","major-minor":"m(maj7)","diminished-seventh":"dim7",other:"maj7(#5)",power:"5"}[e]||"")||""}function getHarmonies(t){const i=[];return t.map(t=>{var{root:t,kind:e,frame:r}=t;i.push({name:getName(t,e),firstFret:r["first-fret"]||1,data:formatNotes(r["frame-note"])})}),uniqBy(i,"name")}function getScoreDuration(t){return last(t)?.endTime}function getMeasureDuration(t,e,r){const i=filter(e,{measureId:t});let n=0;return i.map(t=>{t=find(r,{nodeId:t.id});isEmpty(t)||(n+=t.duration)}),n}function getNoteDuration(t,e){return find(e,{nodeId:t})?.duration||0}function noteTypeToNumber$1(t){return{whole:1,half:2,quarter:4,eighth:8,"16th":16,"32th":32,"64th":64}[t]||""}function getBPM(t){let e=t["direction"];return isArray(e)&&([e]=e),e?.["direction-type"]?.metronome?.["per-minute"]}function getBeats(t){t=t.attributes;return t?.time?.beats}function getBeatType(t){t=t.attributes;return t?.time?.["beat-type"]}function getTimeRange(t){return t-Math.floor(.2*t)}function isTabNote(t){t=t.notations;return!isEmpty(t)&&!isEmpty(t.technical)}function isRest(t){return has(t,"rest")}function isChord(t){return has(t,"chord")}function hasSlur(t){return has(t,"time-modification")}function hasDot(t){return has(t,"dot")?isArray(t.dot)&&2<=t.dot.length?"doubleDot":"dot":""}function createBlankNode(t,e){return{id:t,measureId:e,type:"whole",view:"blank",data:null}}function createRestNode(t,e,r){var i=r["type"];return{id:t,measureId:e,type:i,view:"rest",data:null,dot:hasDot(r)}}function createSingleNode(t,e,r){var{type:i,notations:n,pitch:s}=r,{fret:n,string:o}=n.technical||{},{step:s,octave:a,alter:l}=s;return{id:t,measureId:e,type:i,view:"single",data:{string:o-1,fret:n,step:l?s+"#":s,octave:a},dot:hasDot(r)}}function createChordNode(t,e){var{notations:r,pitch:i}=t,{fret:r,string:n}=r.technical,{step:i,octave:s,alter:o}=i,n={string:n-1,fret:r,step:o?i+"#":i,octave:s};return"chord"===e.view?(e.data.push(n),e):{id:e.id,measureId:e.measureId,type:e.type,view:"chord",data:[e.data,n],dot:e.dot||hasDot(t)}}function appendSlurProps(t,e){t=t["time-modification"];return{slur:{type:e,actualNotes:t["actual-notes"],normalNotes:t["normal-notes"]}}}function calNoteDuration(t,e){const{type:r,slur:i,dot:n}=t;let s=Math.floor(60/e*(4/noteTypeToNumber$1(r))*1e3);if(!isEmpty(i)){const{actualNotes:o,normalNotes:a,type:r}=i;let t=0;t="end"===r?(Math.floor(100/o)+100%o)/100:Math.floor(100/o)/100,s=Math.floor(s*a*t)}return"dot"===n?s=Math.floor(1.5*s):"doubleDot"===n&&(s=Math.floor(1.75*s)),s}function createTimeline(n,t){const s=[];let o=0;return t.map(t=>{var e=find(n,{id:t.measureId})["bpm"],e=calNoteDuration(t,e),r=o,i=o+e;s.push({noteId:t.id,duration:e,startTime:r,startTimeRange:getTimeRange(r),endTime:i,endTimeRange:getTimeRange(i)}),o=i}),s}function parseData(t=[],u={},s=0,o=1){const a=[],d=[];let p=1,h=4,g=4,c=60;return t.map(t=>{if(!isEmpty(t)){var{_number:e,note:r,partId:i}=t,n=(c=getBPM(t)||c,s||c),n=Math.round(n*o);h=getBeats(t)||h,g=getBeatType(t)||g;const l="M_"+e;if(a.push({id:l,partId:i,bpm:n,beats:h,beatType:g}),isEmpty(r))t=createBlankNode("N_"+p,l),d.push(t),p++;else{let t=[],s=(t=isArray(r)?r:[r],u.number&&(t=filter(t,{staff:Number(u.number)})),0),o=0,a="";t.map(t=>{var e="N_"+p;let r={};if(isChord(t)){var i=d.length-1,n=d[i];const r=createChordNode(t,n)||{};void(d[i]={...n,...r})}else isRest(t)?r=createRestNode(e,l,t):isTabNote(t)&&(r=createSingleNode(e,l,t)),hasSlur(t)&&(s=t["time-modification"]["actual-notes"],1===++o?a="start":1<o&&o<s?a="continue":o===s&&(a="end",s=0,o=0),i=appendSlurProps(t,a),r={...r,...i}),isEmpty(r)||(d.push(r),p++)})}}}),{measureList:a,noteList:d,timeline:createTimeline(a,d)}}function numberToNoteType$1(t){return{1:"whole",2:"half",4:"quarter",8:"eighth",16:"16th",32:"32th",64:"64th"}[t]||""}function xmlToJson(t,e=!1){const r=new fxp.XMLParser({ignoreAttributes:!1,attributeNamePrefix:"_",preserveOrder:e});return r.parse(t)}class MxmlQuery{_debug;_bpm;_speed;_oriXml;_oriParts;_oriMeasures;_oriHarmonies;_oriNotes;xmlVersion="";scoreVersion="";scoreType="";clef;tuningStep;harmonies;measures;notes;timeline;constructor(t,e){var r;fxp.XMLValidator.validate(t)?(this._debug=e?.debug,this._bpm=e?.bpm,this._speed=e?.speed,this._oriXml=xmlToJson(t)||{},this._oriParts=findAllParts(this._oriXml),this._oriMeasures=findAllMeasures(this._oriParts),this._oriHarmonies=findAllHarmonies(this._oriMeasures),this._oriNotes=findAllNotes(this._oriMeasures),this.xmlVersion=this._oriXml["?xml"]?._version,this.scoreVersion=this._oriXml["score-partwise"]?._version||this._oriXml["score-timewise"]?._version,this.scoreType=getScoreType(this._oriXml),this.clef=getClef(this._oriMeasures),this.tuningStep=getTuningStep(this._oriMeasures),this.harmonies=getHarmonies(this._oriHarmonies),{measureList:e,noteList:t,timeline:r}=parseData(this._oriMeasures,this.clef,this._bpm,this._speed),this.measures=e,this.notes=t,this.timeline=r,findChordName(this.notes,this.harmonies),this._debug&&console.log(this)):console.error(":: Not valid file type ::")}getScoreDuration(){return getScoreDuration(this.timeline)}getMeasureDuration(t){return getMeasureDuration(t,this.notes,this.timeline)}getNoteDuration(t){return getNoteDuration(t,this.timeline)}}const noteTypeToNumber=noteTypeToNumber$1,numberToNoteType=numberToNoteType$1;export{MxmlQuery,noteTypeToNumber,numberToNoteType};

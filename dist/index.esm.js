import{isEmpty,isArray,filter,isObject,find,orderBy,uniq as uniq$1,has,hasIn}from"lodash";var validator$2={},util$2={};!function(e){var t=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",t="["+t+"][:A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*";const r=new RegExp("^"+t+"$");e.isExist=function(t){return void 0!==t},e.isEmptyObject=function(t){return 0===Object.keys(t).length},e.merge=function(e,r,i){if(r){var s=Object.keys(r),n=s.length;for(let t=0;t<n;t++)e[s[t]]="strict"===i?[r[s[t]]]:r[s[t]]}},e.getValue=function(t){return e.isExist(t)?t:""},e.isName=function(t){t=r.exec(t);return!(null==t)},e.getAllMatches=function(t,e){const r=[];let i=e.exec(t);for(;i;){const n=[];n.startIndex=e.lastIndex-i[0].length;var s=i.length;for(let t=0;t<s;t++)n.push(i[t]);r.push(n),i=e.exec(t)}return r},e.nameRegexp=t}(util$2);const util$1=util$2,defaultOptions$2={allowBooleanAttributes:!1,unpairedTags:[]};function isWhiteSpace(t){return" "===t||"\t"===t||"\n"===t||"\r"===t}function readPI(t,e){for(var r=e;e<t.length;e++)if("?"==t[e]||" "==t[e]){var i=t.substr(r,e-r);if(5<e&&"xml"===i)return getErrorObject("InvalidXml","XML declaration allowed only at the start of the document.",getLineNumberForPosition(t,e));if("?"==t[e]&&">"==t[e+1]){e++;break}}return e}function readCommentAndCDATA(e,r){if(e.length>r+5&&"-"===e[r+1]&&"-"===e[r+2]){for(r+=3;r<e.length;r++)if("-"===e[r]&&"-"===e[r+1]&&">"===e[r+2]){r+=2;break}}else if(e.length>r+8&&"D"===e[r+1]&&"O"===e[r+2]&&"C"===e[r+3]&&"T"===e[r+4]&&"Y"===e[r+5]&&"P"===e[r+6]&&"E"===e[r+7]){let t=1;for(r+=8;r<e.length;r++)if("<"===e[r])t++;else if(">"===e[r]&&0===--t)break}else if(e.length>r+9&&"["===e[r+1]&&"C"===e[r+2]&&"D"===e[r+3]&&"A"===e[r+4]&&"T"===e[r+5]&&"A"===e[r+6]&&"["===e[r+7])for(r+=8;r<e.length;r++)if("]"===e[r]&&"]"===e[r+1]&&">"===e[r+2]){r+=2;break}return r}validator$2.validate=function(s,n){n=Object.assign({},defaultOptions$2,n);const a=[];let o=!1,u=!1;"\ufeff"===s[0]&&(s=s.substr(1));for(let i=0;i<s.length;i++)if("<"===s[i]&&"?"===s[i+1]){if((i=readPI(s,i+=2)).err)return i}else if("<"===s[i]){var l=i;if("!"===s[++i])i=readCommentAndCDATA(s,i);else{let t=!1,e=("/"===s[i]&&(t=!0,i++),"");for(;i<s.length&&">"!==s[i]&&" "!==s[i]&&"\t"!==s[i]&&"\n"!==s[i]&&"\r"!==s[i];i++)e+=s[i];if("/"===(e=e.trim())[e.length-1]&&(e=e.substring(0,e.length-1),i--),!validateTagName(e)){let t;return getErrorObject("InvalidTag",t=0===e.trim().length?"Invalid space after '<'.":"Tag '"+e+"' is an invalid name.",getLineNumberForPosition(s,i))}var d=readAttributeStr(s,i);if(!1===d)return getErrorObject("InvalidAttr","Attributes for '"+e+"' have open quote.",getLineNumberForPosition(s,i));let r=d.value;if(i=d.index,"/"===r[r.length-1]){var m=i-r.length,p=validateAttributeString(r=r.substring(0,r.length-1),n);if(!0!==p)return getErrorObject(p.err.code,p.err.msg,getLineNumberForPosition(s,m+p.err.line));o=!0}else if(t){if(!d.tagClosed)return getErrorObject("InvalidTag","Closing tag '"+e+"' doesn't have proper closing.",getLineNumberForPosition(s,i));if(0<r.trim().length)return getErrorObject("InvalidTag","Closing tag '"+e+"' can't have attributes or invalid starting.",getLineNumberForPosition(s,l));m=a.pop();if(e!==m.tagName)return p=getLineNumberForPosition(s,m.tagStartPos),getErrorObject("InvalidTag","Expected closing tag '"+m.tagName+"' (opened in line "+p.line+", col "+p.col+") instead of closing tag '"+e+"'.",getLineNumberForPosition(s,l));0==a.length&&(u=!0)}else{d=validateAttributeString(r,n);if(!0!==d)return getErrorObject(d.err.code,d.err.msg,getLineNumberForPosition(s,i-r.length+d.err.line));if(!0===u)return getErrorObject("InvalidXml","Multiple possible root nodes found.",getLineNumberForPosition(s,i));-1===n.unpairedTags.indexOf(e)&&a.push({tagName:e,tagStartPos:l}),o=!0}for(i++;i<s.length;i++)if("<"===s[i])if("!"===s[i+1])i=readCommentAndCDATA(s,++i);else{if("?"!==s[i+1])break;if((i=readPI(s,++i)).err)return i}else if("&"===s[i]){var h=validateAmpersand(s,i);if(-1==h)return getErrorObject("InvalidChar","char '&' is not expected.",getLineNumberForPosition(s,i));i=h}else if(!0===u&&!isWhiteSpace(s[i]))return getErrorObject("InvalidXml","Extra text at the end",getLineNumberForPosition(s,i));"<"===s[i]&&i--}}else if(!isWhiteSpace(s[i]))return getErrorObject("InvalidChar","char '"+s[i]+"' is not expected.",getLineNumberForPosition(s,i));return o?1==a.length?getErrorObject("InvalidTag","Unclosed tag '"+a[0].tagName+"'.",getLineNumberForPosition(s,a[0].tagStartPos)):!(0<a.length)||getErrorObject("InvalidXml","Invalid '"+JSON.stringify(a.map(t=>t.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):getErrorObject("InvalidXml","Start tag expected.",1)};const doubleQuote='"',singleQuote="'";function readAttributeStr(t,e){let r="",i="",s=!1;for(;e<t.length;e++){if(t[e]===doubleQuote||t[e]===singleQuote)""===i?i=t[e]:i===t[e]&&(i="");else if(">"===t[e]&&""===i){s=!0;break}r+=t[e]}return""===i&&{value:r,index:e,tagClosed:s}}const validAttrStrRegxp=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function validateAttributeString(t,e){var r=util$1.getAllMatches(t,validAttrStrRegxp);const i={};for(let t=0;t<r.length;t++){if(0===r[t][1].length)return getErrorObject("InvalidAttr","Attribute '"+r[t][2]+"' has no space in starting.",getPositionFromMatch(r[t]));if(void 0!==r[t][3]&&void 0===r[t][4])return getErrorObject("InvalidAttr","Attribute '"+r[t][2]+"' is without value.",getPositionFromMatch(r[t]));if(void 0===r[t][3]&&!e.allowBooleanAttributes)return getErrorObject("InvalidAttr","boolean attribute '"+r[t][2]+"' is not allowed.",getPositionFromMatch(r[t]));var s=r[t][2];if(!validateAttrName(s))return getErrorObject("InvalidAttr","Attribute '"+s+"' is an invalid name.",getPositionFromMatch(r[t]));if(i.hasOwnProperty(s))return getErrorObject("InvalidAttr","Attribute '"+s+"' is repeated.",getPositionFromMatch(r[t]));i[s]=1}return!0}function validateNumberAmpersand(t,e){let r=/\d/;for("x"===t[e]&&(e++,r=/[\da-fA-F]/);e<t.length;e++){if(";"===t[e])return e;if(!t[e].match(r))break}return-1}function validateAmpersand(t,e){if(";"===t[++e])return-1;if("#"===t[e])return validateNumberAmpersand(t,++e);let r=0;for(;e<t.length;e++,r++)if(!(t[e].match(/\w/)&&r<20)){if(";"===t[e])break;return-1}return e}function getErrorObject(t,e,r){return{err:{code:t,msg:e,line:r.line||r,col:r.col}}}function validateAttrName(t){return util$1.isName(t)}function validateTagName(t){return util$1.isName(t)}function getLineNumberForPosition(t,e){t=t.substring(0,e).split(/\r?\n/);return{line:t.length,col:t[t.length-1].length+1}}function getPositionFromMatch(t){return t.startIndex+t[1].length}var OptionsBuilder={};const defaultOptions$1={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0},tagValueProcessor:function(t,e){return e},attributeValueProcessor:function(t,e){return e},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1},buildOptions$1=function(t){return Object.assign({},defaultOptions$1,t)};OptionsBuilder.buildOptions=buildOptions$1,OptionsBuilder.defaultOptions=defaultOptions$1;class XmlNode{constructor(t){this.tagname=t,this.child=[],this[":@"]={}}add(t,e){this.child.push({[t]:e})}addChild(t){t[":@"]&&0<Object.keys(t[":@"]).length?this.child.push({[t.tagname]:t.child,":@":t[":@"]}):this.child.push({[t.tagname]:t.child})}}var xmlNode$1=XmlNode;function readDocType$1(n,a){var o={};if("O"!==n[a+3]||"C"!==n[a+4]||"T"!==n[a+5]||"Y"!==n[a+6]||"P"!==n[a+7]||"E"!==n[a+8])throw new Error("Invalid Tag instead of DOCTYPE");{a+=9;let t=1,e=!1,r=!1,i=!1,s="";for(;a<n.length;a++)if("<"===n[a]){if(e&&"!"===n[a+1]&&"E"===n[a+2]&&"N"===n[a+3]&&"T"===n[a+4]&&"I"===n[a+5]&&"T"===n[a+6]&&"Y"===n[a+7])a+=7,r=!0;else if(e&&"!"===n[a+1]&&"E"===n[a+2]&&"L"===n[a+3]&&"E"===n[a+4]&&"M"===n[a+5]&&"E"===n[a+6]&&"N"===n[a+7]&&"T"===n[a+8])a+=8;else if(e&&"!"===n[a+1]&&"A"===n[a+2]&&"T"===n[a+3]&&"T"===n[a+4]&&"L"===n[a+5]&&"I"===n[a+6]&&"S"===n[a+7]&&"T"===n[a+8])a+=8;else if(e&&"!"===n[a+1]&&"N"===n[a+2]&&"O"===n[a+3]&&"T"===n[a+4]&&"A"===n[a+5]&&"T"===n[a+6]&&"I"===n[a+7]&&"O"===n[a+8]&&"N"===n[a+9])a+=9;else{if("!"!==n[a+1]||"-"!==n[a+2]||"-"!==n[a+3])throw new Error("Invalid DOCTYPE");i=!0}t++,s=""}else if(">"===n[a]){if(i){if("-"!==n[a-1]||"-"!==n[a-2])throw new Error("Invalid XML comment in DOCTYPE");i=!1}else r&&(parseEntityExp(s,o),r=!1);if(0===--t)break}else"["===n[a]?e=!0:s+=n[a];if(0!==t)throw new Error("Unclosed DOCTYPE")}return{entities:o,i:a}}const entityRegex=RegExp("^\\s([a-zA-z0-0]+)[ \t](['\"])([^&]+)\\2");function parseEntityExp(t,e){t=entityRegex.exec(t);t&&(e[t[1]]={regx:RegExp(`&${t[1]};`,"g"),val:t[3]})}var DocTypeReader=readDocType$1;const hexRegex=/^[-+]?0x[a-fA-F0-9]+$/,numRegex=/^([\-\+])?(0*)(\.[0-9]+([eE]\-?[0-9]+)?|[0-9]+(\.[0-9]+([eE]\-?[0-9]+)?)?)$/,consider=(!Number.parseInt&&window.parseInt&&(Number.parseInt=window.parseInt),!Number.parseFloat&&window.parseFloat&&(Number.parseFloat=window.parseFloat),{hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0});function toNumber$1(e,r={}){if(r=Object.assign({},consider,r),e&&"string"==typeof e){let t=e.trim();if(void 0===r.skipLike||!r.skipLike.test(t)){if(r.hex&&hexRegex.test(t))return Number.parseInt(t,16);var i=numRegex.exec(t);if(i){var s=i[1],n=i[2],a=trimZeros(i[3]),i=i[4]||i[6];if(!r.leadingZeros&&0<n.length&&s&&"."!==t[2])return e;if(!r.leadingZeros&&0<n.length&&!s&&"."!==t[1])return e;{var o=Number(t);const u=""+o;return-1!==u.search(/[eE]/)?r.eNotation?o:e:i?r.eNotation?o:e:-1!==t.indexOf(".")?"0"===u&&""===a||u===a||s&&u==="-"+a?o:e:n?a===u||s+a===u?o:e:t===u||t===s+u?o:e}}}}return e}function trimZeros(t){return t&&-1!==t.indexOf(".")&&("."===(t=t.replace(/0+$/,""))?t="0":"."===t[0]?t="0"+t:"."===t[t.length-1]&&(t=t.substr(0,t.length-1))),t}var strnum=toNumber$1;const util=util$2,xmlNode=xmlNode$1,readDocType=DocTypeReader,toNumber=toNumber$1;"<((!\\[CDATA\\[([\\s\\S]*?)(]]>))|((NAME:)?(NAME))([^>]*)>|((\\/)(NAME)\\s*>))([^<]*)".replace(/NAME/g,util.nameRegexp);class OrderedObjParser$1{constructor(t){this.options=t,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={amp:{regex:/&(amp|#38|#x26);/g,val:"&"},apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"}},this.addExternalEntities=addExternalEntities,this.parseXml=parseXml,this.parseTextData=parseTextData,this.resolveNameSpace=resolveNameSpace,this.buildAttributesMap=buildAttributesMap,this.isItStopNode=isItStopNode,this.replaceEntitiesValue=replaceEntitiesValue$2,this.readStopNodeData=readStopNodeData,this.saveTextToParentTag=saveTextToParentTag}}function addExternalEntities(e){var r=Object.keys(e);for(let t=0;t<r.length;t++){var i=r[t];this.lastEntities[i]={regex:new RegExp("&"+i+";","g"),val:e[i]}}}function parseTextData(t,e,r,i,s,n,a){if(void 0!==t&&0<(t=this.options.trimValues&&!i?t.trim():t).length)return a||(t=this.replaceEntitiesValue(t)),null==(i=this.options.tagValueProcessor(e,t,r,s,n))?t:typeof i!=typeof t||i!==t?i:this.options.trimValues||t.trim()===t?parseValue(t,this.options.parseTagValue,this.options.numberParseOptions):t}function resolveNameSpace(t){if(this.options.removeNSPrefix){var e=t.split(":"),r="/"===t.charAt(0)?"/":"";if("xmlns"===e[0])return"";2===e.length&&(t=r+e[1])}return t}const attrsRegx=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function buildAttributesMap(t,r){if(!this.options.ignoreAttributes&&"string"==typeof t){var i=util.getAllMatches(t,attrsRegx),s=i.length;const o={};for(let e=0;e<s;e++){var n=this.resolveNameSpace(i[e][1]);let t=i[e][4];var a=this.options.attributeNamePrefix+n;n.length&&(void 0!==t?(this.options.trimValues&&(t=t.trim()),t=this.replaceEntitiesValue(t),null==(n=this.options.attributeValueProcessor(n,t,r))?o[a]=t:typeof n!=typeof t||n!==t?o[a]=n:o[a]=parseValue(t,this.options.parseAttributeValue,this.options.numberParseOptions)):this.options.allowBooleanAttributes&&(o[a]=!0))}if(Object.keys(o).length){if(this.options.attributesGroupName){const e={};return e[this.options.attributesGroupName]=o,e}return o}}}const parseXml=function(s){s=s.replace(/\r\n?/g,"\n");var t=new xmlNode("!xml");let n=t,a="",o="";for(let i=0;i<s.length;i++)if("<"===s[i])if("/"===s[i+1]){var e=findClosingIndex(s,">",i,"Closing Tag is not closed.");let t=s.substring(i+2,e).trim();!this.options.removeNSPrefix||-1!==(r=t.indexOf(":"))&&(t=t.substr(r+1)),this.options.transformTagName&&(t=this.options.transformTagName(t)),n&&(a=this.saveTextToParentTag(a,n,o)),o=o.substr(0,o.lastIndexOf(".")),n=this.tagsNodeStack.pop(),a="",i=e}else if("?"===s[i+1]){var r=readTagExp(s,i,!1,"?>");if(!r)throw new Error("Pi Tag is not closed.");if(a=this.saveTextToParentTag(a,n,o),!(this.options.ignoreDeclaration&&"?xml"===r.tagName||this.options.ignorePiTags)){const h=new xmlNode(r.tagName);h.add(this.options.textNodeName,""),r.tagName!==r.tagExp&&r.attrExpPresent&&(h[":@"]=this.buildAttributesMap(r.tagExp,o)),n.addChild(h)}i=r.closeIndex+1}else if("!--"===s.substr(i+1,3)){e=findClosingIndex(s,"--\x3e",i+4,"Comment is not closed.");this.options.commentPropName&&(u=s.substring(i+4,e-2),a=this.saveTextToParentTag(a,n,o),n.add(this.options.commentPropName,[{[this.options.textNodeName]:u}])),i=e}else if("!D"===s.substr(i+1,2)){var u=readDocType(s,i);this.docTypeEntities=u.entities,i=u.i}else if("!["===s.substr(i+1,2)){var l=findClosingIndex(s,"]]>",i,"CDATA is not closed.")-2,d=s.substring(i+9,l);if(a=this.saveTextToParentTag(a,n,o),this.options.cdataPropName)n.add(this.options.cdataPropName,[{[this.options.textNodeName]:d}]);else{let t=this.parseTextData(d,n.tagname,o,!0,!1,!0);null==t&&(t=""),n.add(this.options.textNodeName,t)}i=2+l}else{d=readTagExp(s,i,this.options.removeNSPrefix);let e=d.tagName,r=d.tagExp;var l=d.attrExpPresent,m=d.closeIndex,p=(this.options.transformTagName&&(e=this.options.transformTagName(e)),n&&a&&"!xml"!==n.tagname&&(a=this.saveTextToParentTag(a,n,o,!1)),e!==t.tagname&&(o+=o?"."+e:e),n);if(p&&-1!==this.options.unpairedTags.indexOf(p.tagname)&&(n=this.tagsNodeStack.pop()),this.isItStopNode(this.options.stopNodes,o,e)){let t="";if(0<r.length&&r.lastIndexOf("/")===r.length-1)i=d.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(e))i=d.closeIndex;else{p=this.readStopNodeData(s,e,m+1);if(!p)throw new Error("Unexpected end of "+e);i=p.i,t=p.tagContent}const g=new xmlNode(e);e!==r&&l&&(g[":@"]=this.buildAttributesMap(r,o)),t=t&&this.parseTextData(t,e,o,!0,l,!0,!0),o=o.substr(0,o.lastIndexOf(".")),g.add(this.options.textNodeName,t),n.addChild(g)}else{if(0<r.length&&r.lastIndexOf("/")===r.length-1){r="/"===e[e.length-1]?e=e.substr(0,e.length-1):r.substr(0,r.length-1),this.options.transformTagName&&(e=this.options.transformTagName(e));const c=new xmlNode(e);e!==r&&l&&(c[":@"]=this.buildAttributesMap(r,o)),o=o.substr(0,o.lastIndexOf(".")),n.addChild(c)}else{const f=new xmlNode(e);this.tagsNodeStack.push(n),e!==r&&l&&(f[":@"]=this.buildAttributesMap(r,o)),n.addChild(f),n=f}a="",i=m}}else a+=s[i];return t.child},replaceEntitiesValue$2=function(t){if(this.options.processEntities){for(var e in this.docTypeEntities){e=this.docTypeEntities[e];t=t.replace(e.regx,e.val)}for(var r in this.lastEntities){r=this.lastEntities[r];t=t.replace(r.regex,r.val)}if(this.options.htmlEntities)for(var i in this.htmlEntities){i=this.htmlEntities[i];t=t.replace(i.regex,i.val)}}return t};function saveTextToParentTag(t,e,r,i){return t&&(void 0===i&&(i=0===Object.keys(e.child).length),void 0!==(t=this.parseTextData(t,e.tagname,r,!1,!!e[":@"]&&0!==Object.keys(e[":@"]).length,i))&&""!==t&&e.add(this.options.textNodeName,t),t=""),t}function isItStopNode(t,e,r){var i="*."+r;for(const n in t){var s=t[n];if(i===s||e===s)return!0}return!1}function tagExpWithClosingIndex(r,t,i=">"){let s,n="";for(let e=t;e<r.length;e++){let t=r[e];if(s)t===s&&(s="");else if('"'===t||"'"===t)s=t;else if(t===i[0]){if(!i[1])return{data:n,index:e};if(r[e+1]===i[1])return{data:n,index:e}}else"\t"===t&&(t=" ");n+=t}}function findClosingIndex(t,e,r,i){t=t.indexOf(e,r);if(-1===t)throw new Error(i);return t+e.length-1}function readTagExp(i,s,n,a=">"){const o=tagExpWithClosingIndex(i,s+1,a);if(o){let t=o.data;i=o.index,s=t.search(/\s/);let e=t,r=!0;return-1!==s&&(e=t.substr(0,s).replace(/\s\s*$/,""),t=t.substr(s+1)),n&&-1!==(a=e.indexOf(":"))&&(e=e.substr(a+1),r=e!==o.data.substr(a+1)),{tagName:e,tagExp:t,closeIndex:i,attrExpPresent:r}}}function readStopNodeData(t,e,r){var i=r;let s=1;for(;r<t.length;r++)if("<"===t[r])if("/"===t[r+1]){var n=findClosingIndex(t,">",r,e+" is not closed"),a=t.substring(r+2,n).trim();if(a===e&&0===--s)return{tagContent:t.substring(i,r),i:n};r=n}else"?"===t[r+1]?r=findClosingIndex(t,"?>",r+1,"StopNode is not closed."):"!--"===t.substr(r+1,3)?r=findClosingIndex(t,"--\x3e",r+3,"StopNode is not closed."):"!["===t.substr(r+1,2)?r=findClosingIndex(t,"]]>",r,"StopNode is not closed.")-2:(a=readTagExp(t,r,">"))&&((a&&a.tagName)===e&&"/"!==a.tagExp[a.tagExp.length-1]&&s++,r=a.closeIndex)}function parseValue(t,e,r){return e&&"string"==typeof t?"true"===(e=t.trim())||"false"!==e&&toNumber(t,r):util.isExist(t)?t:""}var OrderedObjParser_1=OrderedObjParser$1,node2json={};function prettify$1(t,e){return compress(t,e)}function compress(r,i,s){let n;const a={};for(let t=0;t<r.length;t++){var o=r[t],u=propName$1(o);let e="";if(e=void 0===s?u:s+"."+u,u===i.textNodeName)void 0===n?n=o[u]:n+=""+o[u];else if(void 0!==u&&o[u]){let t=compress(o[u],i,e);var l=isLeafTag(t,i);o[":@"]?assignAttributes(t,o[":@"],e,i):1!==Object.keys(t).length||void 0===t[i.textNodeName]||i.alwaysCreateTextNode?0===Object.keys(t).length&&(i.alwaysCreateTextNode?t[i.textNodeName]="":t=""):t=t[i.textNodeName],void 0!==a[u]&&a.hasOwnProperty(u)?(Array.isArray(a[u])||(a[u]=[a[u]]),a[u].push(t)):i.isArray(u,e,l)?a[u]=[t]:a[u]=t}}return"string"==typeof n?0<n.length&&(a[i.textNodeName]=n):void 0!==n&&(a[i.textNodeName]=n),a}function propName$1(t){var e=Object.keys(t);for(let t=0;t<e.length;t++){var r=e[t];if(":@"!==r)return r}}function assignAttributes(e,r,i,s){if(r){var n=Object.keys(r),a=n.length;for(let t=0;t<a;t++){var o=n[t];s.isArray(o,i+"."+o,!0,!0)?e[o]=[r[o]]:e[o]=r[o]}}}function isLeafTag(t,e){var r=Object.keys(t).length;return!!(0===r||1===r&&t[e.textNodeName])}node2json.prettify=prettify$1;const buildOptions=OptionsBuilder["buildOptions"],OrderedObjParser=OrderedObjParser_1,prettify=node2json["prettify"],validator$1=validator$2;class XMLParser$1{constructor(t){this.externalEntities={},this.options=buildOptions(t)}parse(t,e){if("string"!=typeof t){if(!t.toString)throw new Error("XML data is accepted in String or Bytes[] form.");t=t.toString()}if(e){!0===e&&(e={});e=validator$1.validate(t,e);if(!0!==e)throw Error(`${e.err.msg}:${e.err.line}:`+e.err.col)}const r=new OrderedObjParser(this.options);r.addExternalEntities(this.externalEntities);e=r.parseXml(t);return this.options.preserveOrder||void 0===e?e:prettify(e,this.options)}addEntity(t,e){if(-1!==e.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==t.indexOf("&")||-1!==t.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");this.externalEntities[t]=e}}var XMLParser_1=XMLParser$1;const EOL="\n";function toXml(t,e){return arrToStr(t,e,"",0)}function arrToStr(r,i,s,n){let a="",o="";i.format&&0<i.indentBy.length&&(o=EOL+""+i.indentBy.repeat(n));for(let t=0;t<r.length;t++){var u=r[t],l=propName(u);let e="";if(e=0===s.length?l:s+"."+l,l===i.textNodeName){let t=u[l];isStopNode(e,i)||(t=replaceEntitiesValue$1(t=i.tagValueProcessor(l,t),i)),a+=o+t}else if(l===i.cdataPropName)a+=o+`<![CDATA[${u[l][0][i.textNodeName]}]]>`;else if(l===i.commentPropName)a+=o+`<!--${u[l][0][i.textNodeName]}-->`;else if("?"===l[0]){var d=attr_to_str(u[":@"],i),m="?xml"===l?"":o;let t=u[l][0][i.textNodeName];t=0!==t.length?" "+t:"",a+=m+`<${l}${t}${d}?>`}else{m=attr_to_str(u[":@"],i),d=o+"<"+l+m,u=arrToStr(u[l],i,e,n+1);-1!==i.unpairedTags.indexOf(l)?i.suppressUnpairedNode?a+=d+">":a+=d+"/>":u&&0!==u.length||!i.suppressEmptyNode?a+=d+`>${u}${o}</${l}>`:a+=d+"/>"}}return a}function propName(t){var e=Object.keys(t);for(let t=0;t<e.length;t++){var r=e[t];if(":@"!==r)return r}}function attr_to_str(t,e){let r="";if(t&&!e.ignoreAttributes)for(var i in t){var s;!0===(s=replaceEntitiesValue$1(e.attributeValueProcessor(i,t[i]),e))&&e.suppressBooleanAttributes?r+=" "+i.substr(e.attributeNamePrefix.length):r+=` ${i.substr(e.attributeNamePrefix.length)}="${s}"`}return r}function isStopNode(t,e){var r,i=(t=t.substr(0,t.length-e.textNodeName.length-1)).substr(t.lastIndexOf(".")+1);for(r in e.stopNodes)if(e.stopNodes[r]===t||e.stopNodes[r]==="*."+i)return!0;return!1}function replaceEntitiesValue$1(e,r){if(e&&0<e.length&&r.processEntities)for(let t=0;t<r.entities.length;t++){var i=r.entities[t];e=e.replace(i.regex,i.val)}return e}var orderedJs2Xml=toXml;const buildFromOrderedJs=toXml,defaultOptions={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(t,e){return e},attributeValueProcessor:function(t,e){return e},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],transformTagName:!1};function Builder(t){this.options=Object.assign({},defaultOptions,t),this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=isAttribute),this.processTextOrObjNode=processTextOrObjNode,this.options.format?(this.indentate=indentate,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine=""),this.options.suppressEmptyNode?(this.buildTextNode=buildEmptyTextNode,this.buildObjNode=buildEmptyObjNode):(this.buildTextNode=buildTextValNode,this.buildObjNode=buildObjectNode),this.buildTextValNode=buildTextValNode,this.buildObjectNode=buildObjectNode,this.replaceEntitiesValue=replaceEntitiesValue,this.buildAttrPairStr=buildAttrPairStr}function buildAttrPairStr(t,e){return e=this.options.attributeValueProcessor(t,""+e),e=this.replaceEntitiesValue(e),this.options.suppressBooleanAttributes&&"true"===e?" "+t:" "+t+'="'+e+'"'}function processTextOrObjNode(t,e,r){var i=this.j2x(t,r+1);return void 0!==t[this.options.textNodeName]&&1===Object.keys(t).length?this.buildTextNode(t[this.options.textNodeName],e,i.attrStr,r):this.buildObjNode(i.val,e,i.attrStr,r)}function buildObjectNode(t,e,r,i){let s="</"+e+this.tagEndChar,n="";return"?"===e[0]&&(n="?",s=""),r&&-1===t.indexOf("<")?this.indentate(i)+"<"+e+r+n+">"+t+s:!1!==this.options.commentPropName&&e===this.options.commentPropName&&0===n.length?this.indentate(i)+`<!--${t}-->`+this.newLine:this.indentate(i)+"<"+e+r+n+this.tagEndChar+t+this.indentate(i)+s}function buildEmptyObjNode(t,e,r,i){return""!==t?this.buildObjectNode(t,e,r,i):"?"===e[0]?this.indentate(i)+"<"+e+r+"?"+this.tagEndChar:this.indentate(i)+"<"+e+r+"/"+this.tagEndChar}function buildTextValNode(t,e,r,i){return!1!==this.options.cdataPropName&&e===this.options.cdataPropName?this.indentate(i)+`<![CDATA[${t}]]>`+this.newLine:!1!==this.options.commentPropName&&e===this.options.commentPropName?this.indentate(i)+`<!--${t}-->`+this.newLine:(t=this.options.tagValueProcessor(e,t),""===(t=this.replaceEntitiesValue(t))&&-1!==this.options.unpairedTags.indexOf(e)?this.options.suppressUnpairedNode?this.indentate(i)+"<"+e+this.tagEndChar:this.indentate(i)+"<"+e+"/"+this.tagEndChar:this.indentate(i)+"<"+e+r+">"+t+"</"+e+this.tagEndChar)}function replaceEntitiesValue(e){if(e&&0<e.length&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){var r=this.options.entities[t];e=e.replace(r.regex,r.val)}return e}function buildEmptyTextNode(t,e,r,i){return""===t&&-1!==this.options.unpairedTags.indexOf(e)?this.options.suppressUnpairedNode?this.indentate(i)+"<"+e+this.tagEndChar:this.indentate(i)+"<"+e+"/"+this.tagEndChar:""!==t?this.buildTextValNode(t,e,r,i):"?"===e[0]?this.indentate(i)+"<"+e+r+"?"+this.tagEndChar:this.indentate(i)+"<"+e+r+"/"+this.tagEndChar}function indentate(t){return this.options.indentBy.repeat(t)}function isAttribute(t){return!!t.startsWith(this.options.attributeNamePrefix)&&t.substr(this.attrPrefixLen)}Builder.prototype.build=function(t){return this.options.preserveOrder?buildFromOrderedJs(t,this.options):(Array.isArray(t)&&this.options.arrayNodeName&&1<this.options.arrayNodeName.length&&(t={[this.options.arrayNodeName]:t}),this.j2x(t,0).val)},Builder.prototype.j2x=function(e,r){let i="",s="";for(var n in e)if(void 0!==e[n])if(null===e[n])"?"===n[0]?s+=this.indentate(r)+"<"+n+"?"+this.tagEndChar:s+=this.indentate(r)+"<"+n+"/"+this.tagEndChar;else if(e[n]instanceof Date)s+=this.buildTextNode(e[n],n,"",r);else if("object"!=typeof e[n]){var t=this.isAttribute(n);t?i+=this.buildAttrPairStr(t,""+e[n]):n===this.options.textNodeName?(t=this.options.tagValueProcessor(n,""+e[n]),s+=this.replaceEntitiesValue(t)):s+=this.buildTextNode(e[n],n,"",r)}else if(Array.isArray(e[n])){var a=e[n].length;for(let t=0;t<a;t++){var o=e[n][t];void 0!==o&&(null===o?"?"===n[0]?s+=this.indentate(r)+"<"+n+"?"+this.tagEndChar:s+=this.indentate(r)+"<"+n+"/"+this.tagEndChar:s+="object"==typeof o?this.processTextOrObjNode(o,n,r):this.buildTextNode(o,n,"",r))}}else if(this.options.attributesGroupName&&n===this.options.attributesGroupName){var u=Object.keys(e[n]),l=u.length;for(let t=0;t<l;t++)i+=this.buildAttrPairStr(u[t],""+e[n][u[t]])}else s+=this.processTextOrObjNode(e[n],n,r);return{attrStr:i,val:s}};var json2xml=Builder;const validator=validator$2,XMLParser=XMLParser_1,XMLBuilder=Builder;var fxp={XMLParser:XMLParser,XMLValidator:validator,XMLBuilder:XMLBuilder};function filterPartList(t){const e=[24,25,26,27,28,29,30,31];return isArray(t)?filter(t,t=>e.includes(t?.["midi-instrument"]?.["midi-program"])):isObject(t)&&e.includes(t?.["midi-instrument"]?.["midi-program"])?[t]:[]}function filterPart(r,t){const i=[];return t.map(t=>{t=t._id;let e=null;isArray(r)?e=find(r,{_id:t}):isObject(r)&&r?._id===t&&(e=r),e&&i.push(e)}),i}function findAllParts(t){var t=t?.["score-partwise"],e=filterPartList(t?.["part-list"]?.["score-part"]||[]);return isEmpty(e)?[]:filterPart(t.part,e)}function getMeasure(t,r){if(isArray(t)){const i=[];return t.map(t=>{var e={partId:r};isObject(t)?i.push({...e,...t}):i.push({o:e})}),i}return isObject(t)?[t]:[]}function findAllMeasures(t){let e=[];return t.map(t=>{t=getMeasure(t.measure,t._id);e=e.concat(t)}),e}function findAllHarmonies(t){const i=[],e=filter(t,"harmony");return e.map(t=>{const{_number:e,harmony:r}=t;isArray(r)?r.map(t=>{i.push({...t,measureId:"M_"+e})}):i.push({...r,measureId:"M_"+e})}),i}function getScoreType(t){return isEmpty(t["score-partwise"])?isEmpty(t["score-timewise"])?"":"timewise":"partwise"}function findTab(t){let i;var e;return isArray(t)?t.map(t=>{if("TAB"!==t?.sign)return null;var{line:t,sign:e,_number:r}=t;i={line:t,sign:e,number:r}}):isObject(t)&&({line:t,sign:e}=t,i={line:t,sign:e}),i}function getClef(t){let e;return t.map(t=>{var t=t["attributes"];t&&(t=t["clef"],isEmpty(t)||(e=findTab(t)))}),e}function getTuningStep(t){let s=[];return t.map(t=>{t=t.attributes;if(!isEmpty(t)){const r=t["staff-details"];if(!isEmpty(r)){let e=null;if(isArray(r)?r.map(t=>{t?.["staff-tuning"]&&(e=t)}):e=r,!isEmpty(e["staff-tuning"])){const i=[];e["staff-tuning"].map(t=>{i.push(t["tuning-step"])}),s=i}}}}),s}const NoteNameMap={100:"E",101:"F",102:"F#",103:"G",104:"G#",105:"A",106:"A#",107:"B",108:"C",109:"C#",110:"D",111:"D#",112:"E",113:"F",114:"F#",115:"G",200:"B",201:"C",202:"C#",203:"D",204:"D#",205:"E",206:"F",207:"F#",208:"G",209:"G#",210:"A",211:"A#",212:"B",213:"C",214:"C#",215:"D",300:"G",301:"G#",302:"A",303:"A#",304:"B",305:"C",306:"C#",307:"D",308:"D#",309:"E",310:"F",311:"F#",312:"G",313:"G#",314:"A",315:"A#",400:"D",401:"D#",402:"E",403:"F",404:"F#",405:"G",406:"G#",407:"A",408:"A#",409:"B",410:"C",411:"C#",412:"D",413:"D#",414:"E",415:"F",500:"A",501:"A#",502:"B",503:"C",504:"C#",505:"D",506:"D#",507:"E",508:"F",509:"F#",510:"G",511:"G#",512:"A",513:"A#",514:"B",515:"C",600:"E",601:"F",602:"F#",603:"G",604:"G#",605:"A",606:"A#",607:"B",608:"C",609:"C#",610:"D",611:"D#",612:"E",613:"F",614:"F#",615:"G"},ChordNameMap={"C|E|G":"C","C#|F|G#":"C#","D|F#|A":"D","D#|G|A#":"D#","E|G#|B":"E","F|A|C":"F","F#|A#|C#":"F#","G|B|D":"G","G#|C|D#":"G#","A|C#|E":"A","A#|D|F":"A#","B|D#|F#":"B","C|D#|G":"Cm","C#|E|G#":"C#m","D|F|A":"Dm","D#|F#|A#":"D#m","E|G|B":"Em","F|G#|C":"Fm","F#|A|C#":"F#m","G|A#|D":"Gm","G#|B|D#":"G#m","A|C|E":"Am","A#|C#|F":"A#m","B|D|F#":"Bm","C|D|G":"Csus2","C#|D#|G#":"C#sus2","D|E|A":"Dsus2","D#|F|A#":"D#sus2","E|F#|B":"Esus2","F|G|C":"Fsus2","F#|G#|C#":"F#sus2","G|A|D":"Gsus2","G#|A#|D#":"G#sus2","A|B|E":"Asus2","A#|C|F":"A#sus2","B|C#|F#":"Bsus2","C|F|G":"Csus4","C#|F#|G#":"C#sus4","D|G|A":"Dsus4","D#|G#|A#":"D#sus4","E|A|B":"Esus4","F|A#|C":"Fsus4","F#|B|C#":"F#sus4","G|C|D":"Gsus4","G#|C#|D#":"G#sus4","A|D|E":"Asus4","A#|D#|F":"A#sus4","B|E|F#":"Bsus4","C|D#|F#":"Cdim","C#|E|G":"C#dim","D|F|G#":"Ddim","D#|F#|A":"D#dim","E|G|A#":"Edim","F|G#|B":"Fdim","F#|A|C":"F#dim","G|A#|C#":"Gdim","G#|B|D":"G#dim","A|C|D#":"Adim","A#|C#|E":"A#dim","B|D|F":"Bdim","C|E|G#":"Caug","C#|F|A":"C#aug","D|F#|A#":"Daug","D#|G|B":"D#aug","E|G#|C":"Eaug","F|A|C#":"Faug","F#|A#|D":"F#aug","G|B|D#":"Gaug","G#|C|E":"G#aug","A|C#|F":"Aaug","A#|D|F#":"A#aug","B|D#|G":"Baug","C|E|G|B":"Cmaj7","C#|F|G#|C":"C#maj7","D|F#|A|C#":"Dmaj7","D#|G|A#|D":"D#maj7","E|G#|B|D#":"Emaj7","F|A|C|E":"Fmaj7","F#|A#|C#|F":"F#maj7","G|B|D|F#":"Gmaj7","G#|C|D#|G":"G#maj7","A|C#|E|G#":"Amaj7","A#|D|F|A":"A#maj7","B|D#|F#|A#":"Bmaj7","C|E|G|A#":"C7","C#|F|G#|B":"C#7","D|F#|A|C":"D7","D#|G|A#|C#":"D#7","E|G#|B|D":"E7","F|A|C|D#":"F7","F#|A#|C#|E":"F#7","G|B|D|F":"G7","G#|C|D#|F#":"G#7","A|C#|E|G":"A7","A#|D|F|G#":"A#7","B|D#|F#|A":"B7","C|D#|G|B":"Cm(maj7)","C#|E|G#|C":"C#m(maj7)","D|F|A|C#":"Dm(maj7)","D#|F#|A#|D":"D#m(maj7)","E|G|B|D#":"Em(maj7)","F|G#|C|E":"Fm(maj7)","F#|A|C#|F":"F#m(maj7)","G|A#|D|F#":"Gm(maj7)","G#|B|D#|G":"G#m(maj7)","A|C|E|G#":"Am(maj7)","A#|C#|F|A":"A#m(maj7)","B|D|F#|A#":"Bm(maj7)","C|D#|G|A#":"Cm7","C#|E|G#|B":"C#m7","D|F|A|C":"Dm7","D#|F#|A#|C#":"D#m7","E|G|B|D":"Em7","F|G#|C|D#":"Fm7","F#|A|C#|E":"F#m7","G|A#|D|F":"Gm7","G#|B|D#|F#":"G#m7","A|C|E|G":"Am7","A#|C#|F|G#":"A#m7","B|D|F#|A":"Bm7","C|D|G|B":"Cmaj7sus2","C#|D#|G#|C":"C#maj7sus2","D|E|A|C#":"Dmaj7sus2","D#|F|A#|D":"D#maj7sus2","E|F#|B|D#":"Emaj7sus2","F|G|C|E":"Fmaj7sus2","F#|G#|C#|F":"F#maj7sus2","G|A|D|F#":"Gmaj7sus2","G#|A#|D#|G":"G#maj7sus2","A|B|E|G#":"Amaj7sus2","A#|C|F|A":"A#maj7sus2","B|C#|F#|A#":"Bmaj7sus2","C|D|G|A#":"C7sus2","C#|D#|G#|B":"C#7sus2","D|E|A|C":"D7sus2","D#|F|A#|C#":"D#7sus2","E|F#|B|D":"E7sus2","F|G|C|D#":"F7sus2","F#|G#|C#|E":"F#7sus2","G|A|D|F":"G7sus2","G#|A#|D#|F#":"G#7sus2","A|B|E|G":"A7sus2","A#|C|F|G#":"A#7sus2","B|C#|F#|A":"B7sus2","C|F|G|B":"Cmaj7sus4","C#|F#|G#|C":"C#maj7sus4","D|G|A|C#":"Dmaj7sus4","D#|G#|A#|D":"D#maj7sus4","E|A|B|D#":"Emaj7sus4","F|A#|C|E":"Fmaj7sus4","F#|B|C#|F":"F#maj7sus4","G|C|D|F#":"Gmaj7sus4","G#|C#|D#|G":"G#maj7sus4","A|D|E|G#":"Amaj7sus4","A#|D#|F|A":"A#maj7sus4","B|E|F#|A#":"Bmaj7sus4","C|F|G|A#":"C7sus4","C#|F#|G#|B":"C#7sus4","D|G|A|C":"D7sus4","D#|G#|A#|C#":"D#7sus4","E|A|B|D":"E7sus4","F|A#|C|D#":"F7sus4","F#|B|C#|E":"F#7sus4","G|C|D|F":"G7sus4","G#|C#|D#|F#":"G#7sus4","A|D|E|G":"A7sus4","A#|D#|F|G#":"A#7sus4","B|E|F#|A":"B7sus4","C|E|G|A":"C6","C#|F|G#|A#":"C#6","D|F#|A|B":"D6","D#|G|A#|C":"D#6","E|G#|B|C#":"E6","F|A|C|D":"F6","F#|A#|C#|D#":"F#6","G|B|D|E":"G6","G#|C|D#|F":"G#6","A|C#|E|F#":"A6","A#|D|F|G":"A#6","B|D#|F#|G#":"B6","C|F|G|A":"Cm6","C#|F#|G#|A#":"C#m6","D|G|A|B":"Dm6","D#|G#|A#|C":"D#m6","E|A|B|C#":"Em6","F|A#|C|D":"Fm6","F#|B|C#|D#":"F#m6","G|C|D|E":"Gm6","G#|C#|D#|F":"G#m6","A|D|E|F#":"Am6","A#|D#|F|G":"A#m6","B|E|F#|G#":"Bm6","C|E|G#|B":"Cmaj7(#5)","C#|F|A|C":"C#maj7(#5)","D|F#|A#|C#":"Dmaj7(#5)","D#|G|B|D":"D#maj7(#5)","E|G#|C|D#":"Emaj7(#5)","F|A|C#|E":"Fmaj7(#5)","F#|A#|D|F":"F#maj7(#5)","G|B|D#|F#":"Gmaj7(#5)","G#|C|E|G":"G#maj7(#5)","A|C#|F|G#":"Amaj7(#5)","A#|D|F#|A":"A#maj7(#5)","B|D#|G|A#":"Bmaj7(#5)","C|D#|F#|A#":"C∅","C#|E|G|B":"C#∅","D|F|G#|C":"D∅","D#|F#|A|C#":"D#∅","E|G|A#|D":"E∅","F|G#|B|D#":"F∅","F#|A|C|E":"F#∅","G|A#|C#|F":"G∅","G#|B|D|F#":"G#∅","A|C|D#|G":"A∅","A#|C#|E|G#":"A#∅","B|D|F|A":"B∅","C|D#|F#|A":"Cdim7","C#|E|G|A#":"C#dim7","D|F|G#|B":"Ddim7","D#|F#|A|C":"D#dim7","E|G|A#|C#":"Edim7","F|G#|B|D":"Fdim7","F#|A|C|D#":"F#dim7","G|A#|C#|E":"Gdim7","G#|B|D|F":"G#dim7","A|C|D#|F#":"Adim7","A#|C#|E|G":"A#dim7","B|D|F|G#":"Bdim7","C|G":"C5","C#|G#|":"C#5","D|A|":"D5","D#|A#|":"D#5","E|B|":"E5","F|C|":"F5","F#|C#|":"F#5","G|D|":"G5","G#|D#|":"G#5","A|E|":"A5","A#|F|":"A#5","B|F#|":"B5","C|D|E|G":"Cadd9","C#|D#|F|G#":"C#add9","D|E|F#|A":"Dadd9","D#|F|G|A#":"D#add9","E|F#|G#|B":"Eadd9","F|G|A|C":"Fadd9","F#|G#|A#|C#":"F#add9","G|A|B|D":"Gadd9","G#|A#|C|D#":"G#add9","A|B|C#|E":"Aadd9","A#|C|D|F":"A#add9","B|C#|D#|F#":"Badd9"};function getOrder(t){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];t=e.indexOf(t);const r=e.splice(t);return r.concat(e)}function reoreder(t,e){const r=getOrder(t),i=[];return e.map(t=>{var e=r.indexOf(t);i[e]=t}),i.filter(t=>t&&t.trim())}function getChordName$1(t){let r=[];return(t=orderBy(t,"string","desc")).map(t=>{var{string:t,fret:e}=t,t=100*t+e,e=NoteNameMap[t];r.push(e)}),r=reoreder(r[0],uniq$1(r)),ChordNameMap[r.join("|")]||""}function uniq(t){let[i,s]="";const n=[];return t.map(t=>{var{measureId:e,name:r}=t;e===i&&r===s||(i=e,s=r,n.push(t))}),n}function formatData(t){if(isArray(t)){const r=[];return t.map((t={})=>{var{string:t,fret:e}=t;r.push({string:t,fret:e})}),r}var e;return isObject(t)?({string:t,fret:e}=t,{string:t,fret:e}):[]}function getHarmonies(t){const s=[];return t.map(t=>{var e,{frame:t,measureId:r,root:i}=t;t?.["frame-note"]&&(e=formatData(t["frame-note"]),s.push({measureId:r,name:getChordName$1(e)||i?.["root-step"],firstFret:t["first-fret"]||1,data:e}))}),uniq(s)}function parseToJson(t){const e=new fxp.XMLParser({ignoreAttributes:!1,attributeNamePrefix:"_",preserveOrder:!1});return e.parse(t)}function isTabNote(t){t=t.notations;return!isEmpty(t)&&!isEmpty(t.technical)}function isRest(t){return has(t,"rest")}function isChord(t){return has(t,"chord")}function hasTie(t){return has(t,"tie")}function hasSlur(t){return has(t,"time-modification")}function getDot(t){return has(t,"dot")?isArray(t.dot)&&2<=t.dot.length?"doubleDot":"dot":""}function getBeam(t){return has(t,"beam")?t.beam["#text"]:""}function hasPerMinute(t){return hasIn(t,"direction-type.metronome.per-minute")}function getBpm(t){const e=t["direction"];let r=0;return isArray(e)?e.map(t=>{hasPerMinute(t)&&(r=t["direction-type"].metronome["per-minute"])}):isObject(e)&&hasPerMinute(e)&&(r=e["direction-type"].metronome["per-minute"]),r}function getBeats(t){t=t.attributes;return t?.time?.beats||0}function getBeatType(t){t=t.attributes;return t?.time?.["beat-type"]||0}function getCapo(t){t=t.attributes;return t?.["staff-details"]?.capo}function noteTypeToNumber(t){return{whole:1,half:2,quarter:4,eighth:8,"16th":16,"32th":32,"64th":64,"128th":128,"256th":256,"512th":512,"1024th":1024}[t]}function calNoteDuration(t,e,r,i,s,n){const{view:a,type:o,slur:u,dot:l}=t;if(!o)return 0;t=Math.floor(60/i/(r/noteTypeToNumber(s))*1e3);let d=0;if(d="rest"===a&&"whole"===o?t*e:r/noteTypeToNumber(o)*t,!isEmpty(u)){const{actualNotes:m,normalNotes:p,type:o}=u;let t=0;t="end"===o?(Math.floor(100/m)+100%m)/100:Math.floor(100/m)/100,d=Math.floor(d*p*t)}return"dot"===l?d=Math.floor(1.5*d):"doubleDot"===l&&(d=Math.floor(1.75*d)),Math.round(d/n)}function numberToNoteType(t){return{1:"whole",2:"half",4:"quarter",8:"eighth",16:"16th",32:"32th",64:"64th",128:"128th",256:"256th",512:"512th",1024:"1024th"}[t]}const NoteMap={whole:64,half:32,quarter:16,eighth:8,"16th":4,"32th":2,"64th":1};function calNoteWidth(t,e,r,i){var{view:t,type:s,dot:n}=t;if(!s)return 0;let a=0;switch(a="rest"===t&&"whole"===s?e*NoteMap[numberToNoteType(r)]*i:i*NoteMap[s],n){case"dot":a*=1.5;break;case"doubleDot":a*=1.75}return a}function setMeasureTimeProps(t,e,r){return{...t,time:{start:e,duration:r,end:e+r}}}function setMeasureSizeProps(t,e){return{...t,size:{width:e}}}function setMeasureCoordProps(t,e){return{...t,coord:{x:e}}}function setNoteTimeProps(t,e,r){var i=Math.floor(.2*r),s=e+r,n=0<e-i?e-i:e,i=0<s-i?s-i:s;return{...t,time:{start:e,startRange:n,duration:r,end:e+r,endRang:i}}}function setNoteSlurProps(t,e,r){e=e["time-modification"];return{...t,slur:{type:r,actualNotes:e["actual-notes"],normalNotes:e["normal-notes"]}}}function setNoteTieProps(t,e){var e=e["notations"];return e?.tied?(e=e.tied["_type"],{...t,tie:{type:e}}):t}function setNoteCoordProps(t,e){return{...t,coord:{x:e}}}function setNoteSizeProps(t,e){return{...t,size:{width:e}}}function setNoteDotProps(t,e){return{...t,dot:e}}function setNoteBeamProps(t,e){return{...t,beam:e}}function createSingleNote(t,e){var r,{type:e,notations:i}=e;return isEmpty(i)||isEmpty(i?.technical)?t:({fret:i,string:r}=i.technical,{...t,type:e,view:"single",data:{string:r||0,fret:i||0}})}function setChordNoteProps(t,e){e=e.notations;if(!isObject(e)||!e.technical||!t.data)return t;var{fret:e,string:r}=e.technical,r={string:r,fret:e};if("chord"===t.view&&isArray(t.data))return t.data=[...t.data,r],t.name=getChordName$1(t.data),t;let i=[];return isArray(t.data)?i=[...t.data,r]:isObject(t.data)&&(i=[t.data,r]),{...t,view:"chord",data:i}}function setRestNoteProps(t,e){e=e.type;return{...t,type:e,view:"rest"}}function parseData(A=[],b,C,N){const F=[],E=[];let D=60,x,v,G=0,T=1,y=0,B=0;return A.map((o,u)=>{if(!isEmpty(o)){var{_number:l,note:d,partId:m}=o;const p=getBpm(o)||D,h=getBeats(o)||x,g=getBeatType(o)||v;o=getCapo(o)||G;D=p,x=h,v=g,G=o;let r=0,i=0;const c="M_"+l;let t=[],s=(isEmpty(d)?t=[]:isArray(d)?t=d:isObject(d)&&(t=[d]),0),n=0,a="start";const f=t=>{var e=calNoteDuration(t,h,g,p,C,b),e=(t=setNoteTimeProps(t,i,e),i+=e,calNoteWidth(t=setNoteCoordProps(t,r),h,g,N));t=setNoteSizeProps(t,e),r+=e,y+=e,E.push(t),T++};t.map(t=>{let e={id:"N_"+T,measureId:c};if(isChord(t)){var r=E.length-1;const e=setChordNoteProps(E[r],t);void(E[r]=e)}else{isRest(t)?e=setRestNoteProps(e,t):isTabNote(t)&&(e=createSingleNote(e,t)),hasTie(t)&&(e=setNoteTieProps(e,t)),hasSlur(t)&&(s=t["time-modification"]["actual-notes"],1===++n?a="start":1<n&&n<s?a="continue":n===s&&(a="end",s=0,n=0),e=setNoteSlurProps(e,t,a));r=getDot(t),r=(r&&(e=setNoteDotProps(e,r)),getBeam(t));r&&(e=setNoteBeamProps(e,r)),isEmpty(e)||f(e)}}),isEmpty(t)&&(l={id:"N_"+T,measureId:c,type:"whole",view:"rest"},f(l));let e={id:c,partId:m,bpm:p,beats:h,beatType:g,capo:o};e=setMeasureCoordProps(e=setMeasureSizeProps(e=setMeasureTimeProps(e,B,i),r),r*u),u+1===A.length&&(e.isLast=!0),F.push(e),B+=i}}),{measureList:F,noteList:E,totalWidth:y,totalDuration:B}}class SMGuitar{xmlVersion="";scoreVersion="";scoreType="";clef;tuningStep;harmonies=[];measures=[];notes=[];totalWidth=0;totalDuration=0;getMeasureById=()=>{};getNoteById=()=>{};getNotesByMeasureId=()=>{};_speed=1;_bpmUnit="quarter";_debug=!1;_minWidth=10;_oriXml;_oriParts;_oriMeasures;_oriHarmonies;constructor(t,e){var r,i;fxp.XMLValidator.validate(t)?(e?.debug&&(this._debug=e.debug),e?.speed&&(this._speed=e.speed),e?.bpmUnit&&(this._bpmUnit=e.bpmUnit),e?.minWidth&&(this._minWidth=e.minWidth),this._oriXml=parseToJson(t)||{},this._oriParts=findAllParts(this._oriXml),this._oriMeasures=findAllMeasures(this._oriParts),this._oriHarmonies=findAllHarmonies(this._oriMeasures),this.xmlVersion=this._oriXml["?xml"]?._version,this.scoreVersion=this._oriXml["score-partwise"]?._version||this._oriXml["score-timewise"]?._version,this.scoreType=getScoreType(this._oriXml),this.clef=getClef(this._oriMeasures)||{},this.tuningStep=getTuningStep(this._oriMeasures),this.harmonies=getHarmonies(this._oriHarmonies),{measureList:e,noteList:t,totalWidth:r,totalDuration:i}=parseData(this._oriMeasures,this._speed,this._bpmUnit,this._minWidth),this.measures=e,this.notes=t,this.totalWidth=r,this.totalDuration=i,this.getMeasureById=t=>find(this.measures,{id:t}),this.getNoteById=t=>find(this.notes,{id:t}),this.getNotesByMeasureId=t=>filter(this.notes,{measureId:t}),this._debug&&console.log(this)):console.error(":: Not valid file type ::")}}function getChordName(t){return getChordName$1(t)}function numberToType(t){return numberToNoteType(t)}function typeToNumber(t){return noteTypeToNumber(t)}export{SMGuitar,getChordName,numberToType,typeToNumber};
